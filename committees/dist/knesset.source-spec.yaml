build:
  description: prepare the data for rendering, allows to limit rendering to subset of items
  dependencies:
  - datapackage: data/committees/kns_committee/datapackage.json
  - datapackage: data/people/committees/joined-meeting-attendees-mks/datapackage.json
  - datapackage: data/people/members/joined-mks/datapackage.json
  pipeline:
  - run: load_resource
    parameters:
      url: ../../data/committees/kns_committee/datapackage.json
      resource: kns_committee
  - run: load_resource
    parameters:
      url: ../../data/people/members/joined-mks/datapackage.json
      resource: mk_individual
  - run: load_resource
    parameters:
      url: ../../data/people/committees/joined-meeting-attendees-mks/datapackage.json
      resource: kns_committeesession
#  - run: filter
#    parameters:
#      resources: kns_committeesession
#      in:
#      - CommitteeSessionID: 2068104
#      - CommitteeSessionID: 2068105
#      - CommitteeID: 922
  - run: build_meetings
  - run: knesset.dump_to_path
    parameters:
      out-path: ../../data/committees/dist/build_meetings
      storage-url: http://storage.googleapis.com/knesset-data-pipelines/data/committees-build/build_meetings

render_meetings:
  dependencies:
  - datapackage: data/committees/dist/build_meetings/datapackage.json
  pipeline:
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/build_meetings/datapackage.json
      resource: kns_committee
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/build_meetings/datapackage.json
      resource: mk_individual
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/build_meetings/datapackage.json
      resource: kns_committeesession
  - run: render_meetings
  - run: knesset.dump_to_path
    parameters:
      out-path: ../../data/committees/dist/rendered_meetings_stats
      storage-url: http://storage.googleapis.com/knesset-data-pipelines/data/committees-build/rendered_meetings_stats

render_committees:
  dependencies:
  - datapackage: data/committees/dist/rendered_meetings_stats/datapackage.json
  - datapackage: data/committees/dist/build_meetings/datapackage.json
  pipeline:
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/build_meetings/datapackage.json
      resource: kns_committee
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/build_meetings/datapackage.json
      resource: mk_individual
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/build_meetings/datapackage.json
      resource: kns_committeesession
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/rendered_meetings_stats/datapackage.json
      resource: meetings_stats
  - run: render_committees

create_members:
  dependencies:
  - datapackage: data/people/members/joined-mks/datapackage.json
  - datapackage: data/people/committees/joined-meeting-attendees-mks/datapackage.json
  pipeline:
  # all these tables are loaded into memory
  - run: load_resource
    parameters:
      url: ../../data/people/members/joined-mks/datapackage.json
      resource: mk_individual
  - run: load_resource
    parameters:
      url: ../../data/people/committees/joined-meeting-attendees-mks/datapackage.json
      resource: kns_committeesession
  - run: build_members

build_positions:
  dependencies:
  - datapackage: data/people/members/joined-mks/datapackage.json
  pipeline:
  # all these tables are loaded into memory
  - run: load_resource
    parameters:
      url: ../../data/people/members/joined-mks/datapackage.json
      resource: mk_individual
  - run: build_positions
  - run: dump.to_path
    parameters:
      out-path: ../../data/committees/dist/positions_aggr

create_factions:
  dependencies:
  - datapackage: data/committees/dist/positions_aggr/datapackage.json
  pipeline:
  # all these tables are loaded into memory
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/positions_aggr/datapackage.json
      resource: members
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/positions_aggr/datapackage.json
      resource: positions
  - run: load_resource
    parameters:
      url: ../../data/committees/dist/positions_aggr/datapackage.json
      resource: knessets
  - run: build_factions

#sync:
#  schedule:
#    crontab: "10 1 * * *"
#  dependencies:
#  - pipeline: render_meetings
#  - pipeline: render_committees
#  - pipeline: create_members
#  - pipeline: create_factions
#  pipeline:
#  - run: sync
#    parameters:
#      source: "../../data/committees/dist/dist"
#      target: "gs://knesset-data-pipelines/data/dist"
